# Block direct commits to main branch (but allow merges)
branch=$(git branch --show-current)
if [ "$branch" = "main" ]; then
  # Check if this is a merge commit (MERGE_HEAD exists during merge)
  if [ ! -f .git/MERGE_HEAD ]; then
    echo "‚ùå Cannot commit directly to main. Create a feature branch first."
    echo "   Run: git checkout -b feature/your-feature-name"
    echo ""
    echo "   (Merging into main is allowed)"
    exit 1
  fi
fi

# Check for secrets/API keys in staged files
echo "üîç Checking for secrets..."
gitleaks protect --staged --no-banner
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Secrets detected! Remove them before committing."
  echo "   If this is a false positive, add it to .gitleaksignore"
  exit 1
fi

pnpm run lint
pnpm run type-check
